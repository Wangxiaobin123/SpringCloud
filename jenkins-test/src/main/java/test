// by shengbin
pipeline {
    agent any
    environment {
        def branchName = branch.replaceAll('"', '')
        def BUILDVERSION = sh(script: "echo `date +%s`", returnStdout: true).trim()
        def envValue = envValue.replaceAll('"', '')
    }
    tools {
        maven 'maven'
    }
    // agent { dockerfile true }
    stages {
        stage('Step0 ----- Start') {
            steps {
                echo 'Hello New World'
            }
        }
        stage('Step1 ----- Prepare') {
            steps {
                echo '-----------Prepare finished-----------'
                sh 'git checkout ${branchName}'
                sh 'git pull'
                // sh 'npm install'
                // sh 'npm install --save canvas-toBlob'
                sh 'npm run docker:build'
            }
        }
        stage('Step2 ----- start build dev -----') {
            when {
                environment name: 'envValue', value: 'dev'
            }
            steps {
                sh 'docker tag bmf/front:latest bfdharbor.percent.cn/testbmfprd/nginx-front-prd:${BUILDVERSION} '
                sh 'docker push bfdharbor.percent.cn/testbmfprd/nginx-front-prd:${BUILDVERSION} '
            }
        }
        stage('Step2 ----- start build production -----') {
            when {
                environment name: 'envValue', value: 'production'
            }
            steps {
                sh 'docker tag bmf/front:latest bfdharbor.percent.cn/mfprd/front-nginx-mirror:${BUILDVERSION}'
                sh 'docker push bfdharbor.percent.cn/mfprd/front-nginx-mirror:${BUILDVERSION}'
            }
        }
        stage('Step4 -------- Deploy') {
            steps {
                echo '-----------Deploying-----------'
            }
        }
        stage('Step5 --------- End') {
            steps {
                sh 'docker images | grep \'front\' | awk \'{print $3}\' | xargs docker rmi -f'
                echo 'Bye Success'
            }
        }
    }
}
